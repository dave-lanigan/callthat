---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# callthat

<!-- badges: start -->
[![R-CMD-check](https://github.com/edgararuiz/callthat/workflows/R-CMD-check/badge.svg)](https://github.com/edgararuiz/callthat/actions)
[![Codecov test coverage](https://codecov.io/gh/edgararuiz/callthat/branch/master/graph/badge.svg)](https://codecov.io/gh/edgararuiz/callthat?branch=master)
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
<!-- badges: end -->

`callthat` is meant for `plumber` API developers who plan to distribute their APIs inside an R package.  This package enables the testing of the API's endpoints within the `testthat` framework.  This allows the R Checks to also confirm that the endpoints still behave as expected.  The ultimate goal of `callthat` is to ensure for the package's automated testing confirms that the APIs still work even if the developer did not run the package's test locally.

## Installation

The development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("edgararuiz/callthat")
```

## Usage

### Local

```{r}
library(callthat)

my_api <- call_that_plumber_start()

my_api
```


```{r}
call_that_api_get(my_api, "data") 
```

```{r}
call_that_api_put(my_api, "predict", body = list(weight = 2), encode = "json") 
```

```{r}
call_that_api_post(my_api, "predict", body = list(weight = 2), encode = "json") 
```


### Using inside `testthat`

```{r, eval = FALSE}
library(testthat)
library(httr)

test_that("data endpoint works", {
  test_api <- call_that_plumber_start(port = 9999)
  get_data <- call_that_api_get(test_api, "data") 
  # Test that the request was sucessfull
  expect_equal(get_data$status_code, 200)
  # Confirm that the content of the response is as expected 
  expect_equal(names(content(get_data)[[1]])[1], "mpg")
  call_that_plumber_stop(test_api)
})

```

### RStudio Connect

```{r}
rsc_api <- call_that_rsc_connection("https://colorado.rstudio.com/rsc/access-to-care/api")

rsc_api
```

```{r}
call_that_api_get(rsc_api, "summary", list("state" = "CA")) 
```

### Secured API inside RStudio Connect 

```{r}
secured_api <- call_that_rsc_connection(url = "https://colorado.rstudio.com/rsc/callthat/testapi",
                                       key = Sys.getenv("CONNECT_API_KEY"))

secured_api
```

```{r}
call_that_api_get(secured_api, "data") 
```

```{r}
call_that_api_post(secured_api, "sum", list(a = 2, b = 2), encode = "json")
```


### Generic connection

```{r}
generic_api <- call_that_connection("http://httpbin.org")

generic_api
```

```{r}
call_that_api_post(generic_api, endpoint = "post", body = "A simple text")
```


